### **EGNN 输入**
- **输入张量**：
  - `h`：节点特征，形状为 `[num_nodes, in_node_nf]`。
  - `x`：节点坐标，形状为 `[num_nodes, 3]`。
  - `edge_index`：边的连接信息，形状为 `[2, num_edges]`。
  - `node_mask`（可选）：节点掩码，形状为 `[num_nodes, 1]`。
  - `edge_mask`（可选）：边掩码，形状为 `[num_edges, 1]`。

### **1. 嵌入层（Embedding Layer）**
- **输入**：`h`，形状为 `[num_nodes, in_node_nf]`。
- **处理**：通过 `nn.Linear` 将节点特征嵌入到隐藏空间。
- **输出**：`h`，形状为 `[num_nodes, hidden_nf]`。

### **2. 计算节点间距离和坐标差（`coord2diff` 函数）**
- **输入**：
  - `x`：节点坐标，形状为 `[num_nodes, 3]`。
  - `edge_index`：边的连接信息，形状为 `[2, num_edges]`。
- **处理**：
  - 计算边的起点和终点的坐标差 `coord_diff`，形状为 `[num_edges, 3]`。
  - 计算边的平方距离 `radial`，形状为 `[num_edges, 1]`。
- **输出**：
  - `radial`：边的距离平方，形状为 `[num_edges, 1]`。
  - `coord_diff`：边的坐标差，形状为 `[num_edges, 3]`。

### **3. 距离嵌入（`SinusoidsEmbeddingNew`）**
- **输入**：`radial`，形状为 `[num_edges, 1]`。
- **处理**：将距离嵌入到高维空间（正弦和余弦嵌入）。
- **输出**：嵌入后的距离特征，形状为 `[num_edges, 2 * n_frequencies]`。

### **4. 等变块（`EquivariantBlock`）**
EGNN 包含多个等变块（`n_layers` 个），每个等变块包含：
1. **GCL 层（`GCL`）**：
   - **输入**：
     - `h`：节点特征，形状为 `[num_nodes, hidden_nf]`。
     - `x`：节点坐标，形状为 `[num_nodes, 3]`。
     - `edge_index`：边的连接信息，形状为 `[2, num_edges]`。
     - `edge_attr`：边特征，形状为 `[num_edges, edge_feat_nf]`。
   - **处理**：
     - **边模型（`edge_model`）**：
       - 更新边特征，输出形状为 `[num_edges, hidden_nf]`。
     - **节点模型（`node_model`）**：
       - 聚合边特征并更新节点特征，输出形状为 `[num_nodes, hidden_nf]`。
   - **输出**：
     - 更新后的节点特征 `h`，形状为 `[num_nodes, hidden_nf]`。
     - 边特征 `mij`，形状为 `[num_edges, hidden_nf]`。

2. **等变更新（`EquivariantUpdate`）**：
   - **输入**：
     - `h`：节点特征，形状为 `[num_nodes, hidden_nf]`。
     - `x`：节点坐标，形状为 `[num_nodes, 3]`。
     - `edge_index`：边的连接信息，形状为 `[2, num_edges]`。
     - `coord_diff`：边的坐标差，形状为 `[num_edges, 3]`。
     - `edge_attr`：边特征，形状为 `[num_edges, edge_feat_nf]`。
   - **处理**：
     - 根据边特征和坐标差更新节点坐标。
   - **输出**：
     - 更新后的节点坐标 `x`，形状为 `[num_nodes, 3]`。

### **5. EGNN 输出嵌入层（`embedding_out`）**
- **输入**：`h`，形状为 `[num_nodes, hidden_nf]`。
- **处理**：通过 `nn.Linear` 将节点特征映射到输出维度。
- **输出**：`h`，形状为 `[num_nodes, out_node_nf]`。

### **6. EGNN 输出**
- **输出张量**：
  - `h`：更新后的节点特征，形状为 `[num_nodes, out_node_nf]`。
  - `x`：更新后的节点坐标，形状为 `[num_nodes, 3]`。

### **总结**
EGNN 的数据流动可以总结为以下步骤：
1. 输入节点特征 `h` 和坐标 `x`。
2. 嵌入节点特征到隐藏空间。
3. 计算节点间距离和坐标差。
4. 通过多个等变块更新节点特征和坐标。
5. 最后通过输出嵌入层将节点特征映射到目标维度。
6. 输出更新后的节点特征和坐标。