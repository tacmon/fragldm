# GeoLDM模型训练使用指南

## 一、项目简介

GeoLDM（Geometric Latent Diffusion Models）是一个用于3D分子生成的模型，发表于ICML 2023。该项目使用了潜在扩散模型来生成分子结构，支持QM9和药物数据集的训练和评估。

## 二、环境准备

1. **安装依赖包**：
   ```bash
   pip install -r requirements.txt
   ```

2. **RDKit环境**（可选）：
   如果需要设置RDKit环境，建议使用conda：
   ```bash
   conda create -c conda-forge -n my-rdkit-env rdkit
   conda activate my-rdkit-env
   ```
   然后安装其他所需包。即使不安装RDKit，代码也应该能运行。

## 三、运行main_qm9.py的详细指南

### 1. 基本训练命令

以下是基本的训练命令，用于在QM9数据集上训练GeoLDM模型：

```bash
python main_qm9.py --n_epochs 3000 --n_stability_samples 1000 --diffusion_noise_schedule polynomial_2 --diffusion_noise_precision 1e-5 --diffusion_steps 1000 --diffusion_loss_type l2 --batch_size 64 --nf 256 --n_layers 9 --lr 1e-4 --normalize_factors [1,4,10] --test_epochs 20 --ema_decay 0.9999 --train_diffusion --trainable_ae --latent_nf 1 --exp_name geoldm_qm9
```

### 2. 参数详解

#### 重要参数说明：

- **实验名称**：
  - `--exp_name geoldm_qm9`：定义实验名称，所有输出将保存在`outputs/[exp_name]`目录下

- **模型结构参数**：
  - `--nf 256`：隐藏层特征数量
  - `--n_layers 9`：EGNN层数
  - `--latent_nf 1`：潜在特征的维度
  - `--model egnn_dynamics`：选择模型类型（默认为EGNN）

- **训练参数**：
  - `--n_epochs 3000`：训练轮数
  - `--batch_size 64`：批处理大小
  - `--lr 1e-4`：学习率
  - `--test_epochs 20`：每隔多少轮进行测试

- **扩散模型参数**：
  - `--diffusion_steps 1000`：扩散步数
  - `--diffusion_noise_schedule polynomial_2`：噪声调度类型
  - `--diffusion_noise_precision 1e-5`：噪声精度
  - `--diffusion_loss_type l2`：损失函数类型

- **模型类型控制**：
  - `--train_diffusion`：训练第二阶段的LatentDiffusionModel
  - `--trainable_ae`：训练第一阶段的AutoEncoder模型

- **模型平均**：
  - `--ema_decay 0.9999`：指数移动平均的衰减率（0表示关闭EMA）

- **样本稳定性评估**：
  - `--n_stability_samples 1000`：用于计算稳定性的样本数量

### 3. 使用Weights & Biases (wandb)进行实验跟踪

Wandb是一个流行的实验跟踪工具，可以记录训练过程中的各种指标和可视化结果。以下是使用wandb的相关参数：

- `--wandb_usr [用户名]`：指定wandb用户名
- `--no_wandb`：禁用wandb（当你不想使用wandb时添加）
- `--online True/False`：设置wandb是在线模式还是离线模式

使用wandb的训练命令示例：
```bash
python main_qm9.py --wandb_usr [你的wandb用户名] --exp_name geoldm_qm9_test --n_epochs 3000 [其他参数...]
```

如果你没有指定wandb用户名，程序会尝试自动获取。要使用wandb，你需要首先通过`wandb login`登录。

### 4. 断点续训功能

当训练被中断或你想从某个保存点继续训练时，可以使用断点续训功能：

```bash
python main_qm9.py --resume outputs/geoldm_qm9 --start_epoch 240 --exp_name geoldm_qm9_resume [其他参数...]
```

参数说明：
- `--resume outputs/geoldm_qm9`：指定要从哪个目录恢复训练，该目录应包含之前保存的模型和参数
- `--start_epoch 240`：从第240轮开始继续训练
- `--exp_name geoldm_qm9_resume`：新的实验名称（会自动添加"_resume"后缀）

续训时，程序会从指定目录中加载模型参数、优化器状态和其他配置。注意续训时应保持主要参数与之前训练一致。

### 5. 多GPU训练

该程序支持使用DataParallel进行多GPU训练：

- `--dp True`：启用数据并行（当有多个GPU可用时）
- `--no-cuda`：禁用CUDA（如果想在CPU上运行）

当存在多个GPU且`--dp`设置为True时，程序会自动使用所有可用的GPU进行训练。

### 6. 条件生成

模型支持基于分子属性的条件生成：

```bash
python main_qm9.py --exp_name exp_cond_alpha --conditioning alpha [其他参数...]
```

可选的条件属性包括：`alpha`, `gap`, `homo`, `lumo`, `mu`, `Cv`。

### 7. 模型保存与评估

默认情况下，模型会在验证集性能最好的轮次保存：

- `--save_model True`：启用模型保存
- `--test_epochs 20`：每20轮进行一次测试和可能的保存

保存的模型可用于后续的评估和分子生成。

## 四、模型评估

训练完成后，可以使用以下命令评估模型生成分子的质量：

```bash
python eval_analyze.py --model_path outputs/geoldm_qm9 --n_samples 10000
```

可以使用以下命令可视化生成的分子：

```bash
python eval_sample.py --model_path outputs/geoldm_qm9 --n_samples 10000
```

## 五、完整训练示例

以下是一个完整的训练流程示例，包括wandb跟踪和断点续训：

1. **开始新训练**：
```bash
python main_qm9.py --n_epochs 3000 --n_stability_samples 1000 --diffusion_noise_schedule polynomial_2 --diffusion_noise_precision 1e-5 --diffusion_steps 1000 --diffusion_loss_type l2 --batch_size 64 --nf 256 --n_layers 9 --lr 1e-4 --normalize_factors [1,4,10] --test_epochs 20 --ema_decay 0.9999 --train_diffusion --trainable_ae --latent_nf 1 --exp_name geoldm_qm9 --wandb_usr [你的wandb用户名]
```

2. **从断点继续训练**：
```bash
python main_qm9.py --resume outputs/geoldm_qm9 --start_epoch 240 --n_epochs 3000 --n_stability_samples 1000 --diffusion_noise_schedule polynomial_2 --diffusion_noise_precision 1e-5 --diffusion_steps 1000 --diffusion_loss_type l2 --batch_size 64 --nf 256 --n_layers 9 --lr 1e-4 --normalize_factors [1,4,10] --test_epochs 20 --ema_decay 0.9999 --train_diffusion --trainable_ae --latent_nf 1 --exp_name geoldm_qm9 --wandb_usr [你的wandb用户名]
```

3. **评估模型**：
```bash
python eval_analyze.py --model_path outputs/geoldm_qm9 --n_samples 10000
python eval_sample.py --model_path outputs/geoldm_qm9 --n_samples 10000
```

## 六、注意事项

1. 训练GeoLDM可能需要较大的GPU内存，如果遇到内存不足问题，可以尝试减小batch_size或模型参数（如nf、n_layers）。

2. 对于较长时间的训练，强烈建议使用wandb进行实验跟踪，以便监控训练进度和结果。

3. 保存的模型可以在`outputs/[exp_name]`目录下找到，包括模型参数、优化器状态和配置参数。

4. 项目还提供了预训练模型，可以从[这里](https://drive.google.com/drive/folders/1EQ9koVx-GA98kaKBS8MZ_jJ8g4YhdKsL?usp=sharing)下载。

祝您使用愉快！如有任何问题，请参考项目的GitHub仓库或相关论文。
